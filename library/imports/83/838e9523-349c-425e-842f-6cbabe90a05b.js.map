{"version":3,"sources":["../../../../assets/Script/assets/Script/GameCtrl.js"],"names":["cc","Class","extends","Component","properties","g","Graphics","startLayer","Node","overLayer","scoreLabel","Label","bestLabel","onLoad","initGame","canControl","moveOffset","nextIndex","snake","food","s","mSpeed","string","best","sys","localStorage","getItem","setItem","_startPos","v2","_endPos","onEnable","systemEvent","on","SystemEvent","EventType","KEY_DOWN","onKeyDown","Canvas","instance","node","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","onDisable","off","keyboardE","log","keyCode","e","getLocation","delta","x","y","Math","abs","onBtnDown","v","move","unshift","indexOf","gameOver","draw","Color","GREEN","random","YELLOW","addScore","pop","GRAY","mapIndex","color","fillColor","fillRect","start","startGame","i","forEach","schedule","active","restart","unschedule","RED","scheduleOnce","sp","floor"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;AAyBAA,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;;AAGLC,gBAAY;AACRC,WAAGL,GAAGM,QADE;AAERC,oBAAYP,GAAGQ,IAFP;AAGRC,mBAAWT,GAAGQ,IAHN;AAIRE,oBAAYV,GAAGW,KAJP;AAKRC,mBAAWZ,GAAGW;AALN,KAHP;;AAWL;;AAEAE,UAbK,oBAaK;AACN,aAAKC,QAAL;AACH,KAfI;AAiBLA,YAjBK,sBAiBK;AACN,aAAKC,UAAL,GAAkB,KAAlB;AACA,aAAKC,UAAL,GAAkB,CAAlB,CAFM,CAEmB;AACzB,aAAKC,SAAL,GAAiB,CAAjB,CAHM,CAGmB;AACzB,aAAKC,KAAL,GAAa,CAAC,GAAD,EAAM,GAAN,CAAb;AACA,aAAKC,IAAL,GAAY,GAAZ;;AAEA,aAAKC,CAAL,GAAS,CAAT;AACA,aAAKC,MAAL,GAAc,CAAd;;AAEA,aAAKX,UAAL,CAAgBY,MAAhB,GAAyB,KAAKF,CAAL,GAAS,CAAlC;AACA,YAAIG,OAAOvB,GAAGwB,GAAH,CAAOC,YAAP,CAAoBC,OAApB,CAA4B,YAA5B,CAAX;AACA,YAAI,CAACH,IAAL,EAAU;AACNA,mBAAO,CAAP;AACAvB,eAAGwB,GAAH,CAAOC,YAAP,CAAoBE,OAApB,CAA4B,YAA5B,EAA0C,CAA1C;AACH;AACD,aAAKf,SAAL,CAAeU,MAAf,GAAwBC,IAAxB;;AAEA,aAAKK,SAAL,GAAiB5B,GAAG6B,EAAH,CAAM,CAAN,EAAQ,CAAR,CAAjB;AACA,aAAKC,OAAL,GAAe9B,GAAG6B,EAAH,CAAM,CAAN,EAAQ,CAAR,CAAf;AACH,KArCI;AAuCLE,YAvCK,sBAuCK;AACN/B,WAAGgC,WAAH,CAAeC,EAAf,CAAkBjC,GAAGkC,WAAH,CAAeC,SAAf,CAAyBC,QAA3C,EAAqD,KAAKC,SAA1D,EAAqE,IAArE;AACArC,WAAGsC,MAAH,CAAUC,QAAV,CAAmBC,IAAnB,CAAwBP,EAAxB,CAA2BjC,GAAGQ,IAAH,CAAQ2B,SAAR,CAAkBM,WAA7C,EAA0D,KAAKC,YAA/D,EAA6E,IAA7E;AACA1C,WAAGsC,MAAH,CAAUC,QAAV,CAAmBC,IAAnB,CAAwBP,EAAxB,CAA2BjC,GAAGQ,IAAH,CAAQ2B,SAAR,CAAkBQ,UAA7C,EAAyD,KAAKC,WAA9D,EAA2E,IAA3E;AACA5C,WAAGsC,MAAH,CAAUC,QAAV,CAAmBC,IAAnB,CAAwBP,EAAxB,CAA2BjC,GAAGQ,IAAH,CAAQ2B,SAAR,CAAkBU,SAA7C,EAAwD,KAAKC,UAA7D,EAAyE,IAAzE;AACH,KA5CI;AA8CLC,aA9CK,uBA8CM;AACP/C,WAAGgC,WAAH,CAAegB,GAAf,CAAmBhD,GAAGkC,WAAH,CAAeC,SAAf,CAAyBC,QAA5C,EAAsD,KAAKC,SAA3D,EAAsE,IAAtE;AACArC,WAAGsC,MAAH,CAAUC,QAAV,CAAmBC,IAAnB,CAAwBQ,GAAxB,CAA4BhD,GAAGQ,IAAH,CAAQ2B,SAAR,CAAkBM,WAA9C,EAA2D,KAAKC,YAAhE,EAA8E,IAA9E;AACA1C,WAAGsC,MAAH,CAAUC,QAAV,CAAmBC,IAAnB,CAAwBQ,GAAxB,CAA4BhD,GAAGQ,IAAH,CAAQ2B,SAAR,CAAkBQ,UAA9C,EAA0D,KAAKC,WAA/D,EAA4E,IAA5E;AACA5C,WAAGsC,MAAH,CAAUC,QAAV,CAAmBC,IAAnB,CAAwBQ,GAAxB,CAA4BhD,GAAGQ,IAAH,CAAQ2B,SAAR,CAAkBU,SAA9C,EAAyD,KAAKC,UAA9D,EAA0E,IAA1E;AACH,KAnDI;AAqDLT,aArDK,qBAqDKY,SArDL,EAqDe;AAChB,YAAI,CAAC,KAAKlC,UAAV,EAAqB;AACjB;AACH;AACDf,WAAGkD,GAAH,CAAO,cAAcD,UAAUE,OAA/B;AACA,aAAKnC,UAAL,GAAkB,KAAKE,KAAL,CAAW,CAAX,IAAgB,KAAKA,KAAL,CAAW,CAAX,CAAhB,KAAkC,KAAKD,SAAL,GAAiB,CAAC,CAAC,CAAF,EAAI,EAAJ,EAAO,CAAP,EAAS,CAAC,EAAV,EAAcgC,UAAUE,OAAV,GAAoB,EAAlC,KAAyC,KAAKnC,UAAjG,IAA+G,KAAKA,UAApH,GAAgI,KAAKC,SAAvJ;AACH,KA3DI;AA6DLyB,gBA7DK,wBA6DQU,CA7DR,EA6DU;AACX,aAAKxB,SAAL,GAAiBwB,EAAEC,WAAF,EAAjB;AACH,KA/DI;AAiELT,eAjEK,uBAiEOQ,CAjEP,EAiES;AACV,aAAKtB,OAAL,GAAesB,EAAEC,WAAF,EAAf;AACH,KAnEI;AAqELP,cArEK,sBAqEMM,CArEN,EAqEQ;AACT,YAAIE,QAAQtD,GAAG6B,EAAH,CAAM,KAAKC,OAAL,CAAayB,CAAb,GAAe,KAAK3B,SAAL,CAAe2B,CAApC,EAAuC,KAAKzB,OAAL,CAAa0B,CAAb,GAAe,KAAK5B,SAAL,CAAe4B,CAArE,CAAZ;AACA,YAAIC,KAAKC,GAAL,CAASJ,MAAMC,CAAf,IAAoB,EAApB,IAA0BE,KAAKC,GAAL,CAASJ,MAAME,CAAf,IAAoB,CAAlD,EAAoD;AAChD;AACH;AACD,YAAIC,KAAKC,GAAL,CAASJ,MAAMC,CAAf,IAAoBE,KAAKC,GAAL,CAASJ,MAAME,CAAf,CAAxB,EAA0C;AACtC,gBAAIF,MAAMC,CAAN,GAAU,CAAd,EAAgB;AACZ;AACAH,kBAAED,OAAF,GAAY,EAAZ;AACH,aAHD,MAGM;AACF;AACAC,kBAAED,OAAF,GAAY,EAAZ;AACH;AACJ,SARD,MAQM;AACF,gBAAIG,MAAME,CAAN,GAAU,CAAd,EAAgB;AACZ;AACAJ,kBAAED,OAAF,GAAY,EAAZ;AACH,aAHD,MAGM;AACF;AACAC,kBAAED,OAAF,GAAY,EAAZ;AACH;AACJ;AACD,aAAKd,SAAL,CAAee,CAAf;AACH,KA5FI;AA8FLO,aA9FK,qBA8FKP,CA9FL,EA8FQQ,CA9FR,EA8FU;AACXR,UAAED,OAAF,GAAY,CAAC,CAACS,CAAd;AACA,aAAKvB,SAAL,CAAee,CAAf;AACH,KAjGI;AAmGLS,QAnGK,kBAmGC;AACF,aAAK5C,SAAL,GAAiB,KAAKC,KAAL,CAAW,CAAX,IAAgB,KAAKF,UAAtC;AACA;AACA,aAAKE,KAAL,CAAW4C,OAAX,CAAmB,KAAK7C,SAAxB;AACA;AACA,YAAI,KAAKC,KAAL,CAAW6C,OAAX,CAAmB,KAAK9C,SAAxB,EAAmC,CAAnC,IAAwC,CAA5C,EAA8C;AAC1C,iBAAK+C,QAAL;AACH;;AAED;AACA,YAAI,KAAKhD,UAAL,IAAmB,CAAC,EAApB,IAA0B,KAAKC,SAAL,GAAiB,CAA/C,EAAkD;AAC9C,iBAAKC,KAAL,CAAW,CAAX,IAAgB,KAAKA,KAAL,CAAW,CAAX,IAAgB,GAAhC;AACH,SAFD,MAEO,IAAI,KAAKF,UAAL,IAAmB,EAAnB,IAAyB,KAAKC,SAAL,GAAiB,GAA9C,EAAkD;AACrD,iBAAKC,KAAL,CAAW,CAAX,IAAgB,KAAKA,KAAL,CAAW,CAAX,IAAgB,GAAhC;AACH,SAFM,MAEA,IAAI,KAAKF,UAAL,IAAmB,CAAnB,KAAyB,KAAKC,SAAL,GAAiB,EAAjB,IAAuB,CAAvB,IAA4B,KAAKA,SAAL,GAAiB,GAAtE,CAAJ,EAA+E;AAClF,iBAAKC,KAAL,CAAW,CAAX,IAAgB,KAAKA,KAAL,CAAW,CAAX,IAAgB,EAAhC;AACH,SAFM,MAEA,IAAI,KAAKF,UAAL,IAAmB,CAAC,CAApB,KAA0B,KAAKC,SAAL,GAAiB,EAAjB,IAAuB,EAAvB,IAA6B,KAAKA,SAAL,GAAiB,CAAxE,CAAJ,EAA+E;AAClF,iBAAKC,KAAL,CAAW,CAAX,IAAgB,KAAKA,KAAL,CAAW,CAAX,IAAgB,EAAhC;AACH;;AAED;AACA,aAAK+C,IAAL,CAAU,KAAK/C,KAAL,CAAW,CAAX,CAAV,EAAyBlB,GAAGkE,KAAH,CAASC,KAAlC;AACA;AACA,YAAI,KAAKlD,SAAL,IAAkB,KAAKE,IAA3B,EAAgC;AAC5B;AACA,mBAAM,KAAKD,KAAL,CAAW6C,OAAX,CAAmB,KAAK5C,IAAL,GAAY,CAAC,EAAEsC,KAAKW,MAAL,KAAgB,GAAlB,CAAhC,KAA2D,CAAjE;AACA;AACA,iBAAKH,IAAL,CAAU,KAAK9C,IAAf,EAAqBnB,GAAGkE,KAAH,CAASG,MAA9B;AACA,iBAAKC,QAAL,CAAc,CAAd;AACH,SAND,MAMM;AACF;AACA,iBAAKL,IAAL,CAAU,KAAK/C,KAAL,CAAWqD,GAAX,EAAV,EAA4BvE,GAAGkE,KAAH,CAASM,IAArC;AACH;AACJ,KApII;AAsILP,QAtIK,gBAsIAQ,QAtIA,EAsIUC,KAtIV,EAsIgB;AACjB,aAAKrE,CAAL,CAAOsE,SAAP,GAAmBD,KAAnB;AACA,aAAKrE,CAAL,CAAOuE,QAAP,CAAgBH,WAAW,EAAX,GAAgB,EAAhB,GAAqB,CAArC,EAAwC,CAAC,EAAEA,WAAW,EAAb,CAAD,GAAoB,EAApB,GAAyB,CAAjE,EAAoE,EAApE,EAAwE,EAAxE;AACH,KAzII;AA2ILI,SA3IK,mBA2II,CACR,CA5II;AA8ILC,aA9IK,uBA8IM;AAAA;;AACP;AACA,aAAK,IAAIC,IAAE,CAAX,EAAcA,IAAE,GAAhB,EAAqBA,GAArB,EAAyB;AACrB,iBAAKd,IAAL,CAAUc,CAAV,EAAa/E,GAAGkE,KAAH,CAASM,IAAtB;AACH;AACD;AACA,aAAKtD,KAAL,CAAW8D,OAAX,CAAmB,aAAG;AAClB,kBAAKf,IAAL,CAAUL,CAAV,EAAa5D,GAAGkE,KAAH,CAASC,KAAtB;AACH,SAFD;;AAIA;AACA,aAAKF,IAAL,CAAU,KAAK9C,IAAf,EAAqBnB,GAAGkE,KAAH,CAASG,MAA9B;;AAEA,aAAKY,QAAL,CAAc,KAAKpB,IAAnB,EAAyB,IAAE,KAAKxC,MAAhC;AACA,aAAKN,UAAL,GAAkB,IAAlB;;AAEA,aAAKR,UAAL,CAAgB2E,MAAhB,GAAyB,KAAzB;AACA,aAAKzE,SAAL,CAAeyE,MAAf,GAAwB,KAAxB;AACH,KAhKI;AAkKLC,WAlKK,qBAkKI;AACL,aAAKrE,QAAL;AACA,aAAKgE,SAAL;AACH,KArKI;AAuKLd,YAvKK,sBAuKK;AAAA;;AACNhE,WAAGkD,GAAH,CAAO,WAAP;AACA,aAAKkC,UAAL,CAAgB,KAAKvB,IAArB;AACA,aAAK9C,UAAL,GAAkB,KAAlB;AACA;AACA,aAAKG,KAAL,CAAW8D,OAAX,CAAmB,aAAK;AACpB,mBAAKf,IAAL,CAAUL,CAAV,EAAa5D,GAAGkE,KAAH,CAASmB,GAAtB;AACH,SAFD;;AAIA,aAAKC,YAAL,CAAkB,YAAI;AAClB,mBAAK7E,SAAL,CAAeyE,MAAf,GAAwB,IAAxB;AACH,SAFD,EAEG,CAFH;;AAIA,YAAI3D,OAAOvB,GAAGwB,GAAH,CAAOC,YAAP,CAAoBC,OAApB,CAA4B,YAA5B,CAAX;AACA1B,WAAGwB,GAAH,CAAOC,YAAP,CAAoBE,OAApB,CAA4B,YAA5B,EAA0C,KAAKP,CAAL,GAAOG,IAAP,GAAY,KAAKH,CAAjB,GAAmBG,IAA7D;AACH,KAtLI;AAwLL+C,YAxLK,oBAwLIlD,CAxLJ,EAwLM;AACP,aAAKA,CAAL,IAAUA,CAAV;AACA,aAAKV,UAAL,CAAgBY,MAAhB,GAAyB,KAAKF,CAA9B;AACA,YAAI,KAAKA,CAAL,GAAS,EAAb,EAAgB;AACZ,gBAAImE,KAAK,KAAKlE,MAAL,GAAcoC,KAAK+B,KAAL,CAAW,KAAKpE,CAAL,GAAS,EAApB,CAAvB;AACA,gBAAImE,MAAM,EAAV,EAAa;AACT;AACAvF,mBAAGkD,GAAH,CAAO,SAASqC,EAAhB;AACA,qBAAKN,QAAL,CAAc,KAAKpB,IAAnB,EAAyB,IAAE0B,EAA3B;AACH;AACJ;AACJ;;AAED;;AArMK,CAAT","file":"GameCtrl.js","sourceRoot":"../../../../assets/Script","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\n\n/**\n *  参考：https://forum.cocos.com/t/topic/73426\n *  地图为20*20大小，左下角编号为0， 向右每个格子加1，向上每个格子加20，\n *  380\n *  360\n *  340\n *  320\n *  300\n *  280\n *  260\n *  240\n *  220\n *  200\n *  180\n *  160\n *  140\n *  120\n *  100\n *  80\n *  60\n *  40.............................................49\n *  20.............................................29\n *  0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19\n */\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        g: cc.Graphics,\n        startLayer: cc.Node,\n        overLayer: cc.Node,\n        scoreLabel: cc.Label,\n        bestLabel: cc.Label,\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad () {\n        this.initGame();\n    },\n\n    initGame(){\n        this.canControl = false;\n        this.moveOffset = 1;     // 蛇头变化值，默认向右走 +1\n        this.nextIndex = 0;      // 下一个蛇头位置id \n        this.snake = [202, 201]; \n        this.food = 115;\n\n        this.s = 0;\n        this.mSpeed = 5;\n\n        this.scoreLabel.string = this.s = 0;\n        let best = cc.sys.localStorage.getItem(\"best_score\");\n        if (!best){\n            best = 0;\n            cc.sys.localStorage.setItem(\"best_score\", 0);\n        }\n        this.bestLabel.string = best;\n\n        this._startPos = cc.v2(0,0);\n        this._endPos = cc.v2(0,0);\n    },\n\n    onEnable(){\n        cc.systemEvent.on(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\n        cc.Canvas.instance.node.on(cc.Node.EventType.TOUCH_START, this.onTouchStart, this);\n        cc.Canvas.instance.node.on(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this);\n        cc.Canvas.instance.node.on(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this);\n    },\n\n    onDisable(){\n        cc.systemEvent.off(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\n        cc.Canvas.instance.node.off(cc.Node.EventType.TOUCH_START, this.onTouchStart, this);\n        cc.Canvas.instance.node.off(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this);\n        cc.Canvas.instance.node.off(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this);\n    },\n\n    onKeyDown(keyboardE){\n        if (!this.canControl){\n            return;\n        }\n        cc.log(\"keyCode: \" + keyboardE.keyCode);\n        this.moveOffset = this.snake[1] - this.snake[0] == (this.nextIndex = [-1,20,1,-20][keyboardE.keyCode - 37] || this.moveOffset) ? this.moveOffset: this.nextIndex;\n    },\n\n    onTouchStart(e){\n        this._startPos = e.getLocation();\n    },\n\n    onTouchMove(e){\n        this._endPos = e.getLocation();\n    },\n\n    onTouchEnd(e){\n        let delta = cc.v2(this._endPos.x-this._startPos.x, this._endPos.y-this._startPos.y);\n        if (Math.abs(delta.x) < 10 && Math.abs(delta.y) < 6){\n            return;\n        }\n        if (Math.abs(delta.x) > Math.abs(delta.y)){\n            if (delta.x < 0){\n                // 左\n                e.keyCode = 37;\n            } else{\n                // 右\n                e.keyCode = 39;\n            }\n        } else{\n            if (delta.y < 0){\n                // 下\n                e.keyCode = 40;\n            } else{\n                // 上\n                e.keyCode = 38;\n            }\n        }\n        this.onKeyDown(e);\n    },\n\n    onBtnDown(e, v){\n        e.keyCode = ~~v;\n        this.onKeyDown(e);\n    },\n\n    move(){\n        this.nextIndex = this.snake[0] + this.moveOffset;\n        // 把新蛇头加入进去\n        this.snake.unshift(this.nextIndex);\n        // 判断新蛇头是否碰到自己\n        if (this.snake.indexOf(this.nextIndex, 1) > 0){\n            this.gameOver();\n        }\n\n        // 蛇头越界修复\n        if (this.moveOffset == -20 && this.nextIndex < 0) {\n            this.snake[0] = this.snake[0] + 400;\n        } else if (this.moveOffset == 20 && this.nextIndex > 399){\n            this.snake[0] = this.snake[0] - 400;\n        } else if (this.moveOffset == 1 && (this.nextIndex % 20 == 0 || this.nextIndex > 399)){\n            this.snake[0] = this.snake[0] - 20;\n        } else if (this.moveOffset == -1 && (this.nextIndex % 20 == 19 || this.nextIndex < 0)){\n            this.snake[0] = this.snake[0] + 20;\n        }\n\n        // 画出当前蛇头\n        this.draw(this.snake[0], cc.Color.GREEN);\n        // 如果当前蛇头是产生的糖果，则产生新的糖果\n        if (this.nextIndex == this.food){\n            // 产生糖果的位置不能存在蛇\n            while(this.snake.indexOf(this.food = ~~(Math.random() * 400)) >= 0);\n            // 产生新的食物\n            this.draw(this.food, cc.Color.YELLOW);\n            this.addScore(1);\n        } else{\n            // 删除蛇尾，即整体移动一格\n            this.draw(this.snake.pop(), cc.Color.GRAY);\n        }\n    },\n\n    draw(mapIndex, color){\n        this.g.fillColor = color;\n        this.g.fillRect(mapIndex % 20 * 18 + 2, ~~(mapIndex / 20) * 18 + 2, 16, 16);\n    },\n\n    start () {\n    },\n\n    startGame(){\n        // 棋盘\n        for (let i=0; i<400; i++){\n            this.draw(i, cc.Color.GRAY);\n        }\n        // 初始蛇\n        this.snake.forEach(v=>{\n            this.draw(v, cc.Color.GREEN);\n        });\n\n        // 食物\n        this.draw(this.food, cc.Color.YELLOW);\n\n        this.schedule(this.move, 1/this.mSpeed);\n        this.canControl = true;\n\n        this.startLayer.active = false;\n        this.overLayer.active = false;\n    },\n\n    restart(){\n        this.initGame();\n        this.startGame();\n    },\n\n    gameOver(){\n        cc.log(\"gameover.\");\n        this.unschedule(this.move);\n        this.canControl = false;\n        // 变红色\n        this.snake.forEach(v => {\n            this.draw(v, cc.Color.RED);\n        });\n\n        this.scheduleOnce(()=>{\n            this.overLayer.active = true;\n        }, 1);\n\n        let best = cc.sys.localStorage.getItem(\"best_score\");\n        cc.sys.localStorage.setItem(\"best_score\", this.s>best?this.s:best);\n    },\n\n    addScore(s){\n        this.s += s;\n        this.scoreLabel.string = this.s;\n        if (this.s > 10){\n            let sp = this.mSpeed + Math.floor(this.s / 10);\n            if (sp <= 15){\n                // 更新移动速度\n                cc.log(\"sp: \" + sp);\n                this.schedule(this.move, 1/sp);\n            }\n        }\n    }\n\n    // update (dt) {},\n});\n"]}